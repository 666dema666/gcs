<?xml version="1.0"?>
<project name="gcs" default="bundle">
	<property name="app" value="gcs"/>
	<property name="src" value="src"/>
	<property name="lib" value="libraries"/>
	<property name="toolkit" value="toolkit-4.0.0.jar"/>
	<property name="toolkit_lib" value="../toolkit/libraries"/>
	<property name="toolkit_path" value="${toolkit_lib}/${toolkit}"/>
	<property name="apple_stubs" value="apple_stubs.jar"/>
	<property name="apple_stubs_path" value="../apple_stubs/${apple_stubs}"/>
	<property name="trove" value="trove-3.0.3.jar"/>
	<property name="trove_path" value="${toolkit_lib}/trove-3.0.3.jar"/>
	<property name="iText" value="iText-2.1.7.jar"/>
	<property name="iText_path" value="${lib}/${iText}"/>
	<property name="build_root" value="ant_build"/>
	<property name="gcs_build" value="${build_root}/${app}"/>
	<property name="dist_build" value="${build_root}/dist"/>
	<property name="annotations_src" value="${build_root}/annotations"/>
	<property name="min_jdk" value="1.8"/>
	<property name="app_name" value="GURPS Character Sheet"/>
	<property name="copyright_owner" value="Richard A. Wilkes"/>
	<property name="primary_version" value="4.0.0"/>
	<property name="dist_name" value="GCS-${primary_version}"/>
	<property name="dist_root" value="${dist_build}/${dist_name}"/>
	<property name="build_app_bundle" value="${dist_root}/${app_name}.app/Contents"/>
	<property name="bundle_res" value="${build_app_bundle}/Resources"/>
	<property name="java_bundle_dir" value="${build_app_bundle}/Java"/>
	<property name="splash_path" value="com/trollworks/gcs/app/images/Splash.gif"/>
	<property name="launcher_stub_src" value="com/trollworks/gcs/app/GCS.java"/>
	<property name="icons" value="graphics/icons"/>

	<tstamp>
		<format property="version" pattern="${primary_version}.yyyyMMddHHmmss"/>
	</tstamp>
	<tstamp>
		<format property="year" pattern="yyyy"/>
	</tstamp>

	<target name="clean" description="Clean up after a build">
		<delete dir="${build_root}"/>
		<delete>
			<fileset dir="." includes="GCS-*.zip"/>
			<fileset dir="${lib}" includes="${app}-*.jar"/>
		</delete>
	</target>

	<target name="build" description="Build GCS" depends="clean">
		<mkdir dir="${gcs_build}"/>
		<mkdir dir="${annotations_src}"/>

		<!-- Compile the code. -->
		<javac srcdir="${src}" destdir="${gcs_build}" debug="no" optimize="yes"
			target="${min_jdk}" source="${min_jdk}" deprecation="true"
			excludes="${launcher_stub_src}" includeantruntime="no">
			<classpath>
				<pathelement location="${toolkit_path}"/>
				<pathelement location="${trove_path}"/>
				<pathelement location="${iText_path}"/>
				<pathelement location="${apple_stubs_path}"/>
			</classpath>
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-serial"/>
			<compilerarg value="-processorpath"/>
			<compilerarg value="${toolkit_lib}/toolkit_annotation_processors.jar"/>
			<compilerarg value="-s"/>
			<compilerarg value="${annotations_src}"/>
			<compilerarg value="-implicit:class"/>
		</javac>

		<!-- Compile the launcher code to be compatible with Java 1.1. -->
		<javac srcdir="${src}" destdir="${gcs_build}"
			includes="${launcher_stub_src}" debug="no" optimize="yes"
			target="1.1" source="1.1" deprecation="true" includeantruntime="no">
			<classpath>
				<pathelement location="${toolkit_path}"/>
			</classpath>
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-options"/>
		</javac>

		<!-- Copy the resources over. -->
		<copy todir="${gcs_build}">
			<fileset dir="${src}" includes="**/*.txt,**/*.png,**/*.gif"/>
		</copy>

		<!-- Create the jar file. -->
		<jar destfile="${lib}/${app}-${primary_version}.jar" basedir="${gcs_build}" duplicate="fail">
			<manifest>
				<attribute name="Class-Path" value="${toolkit} ${trove} ${iText} ${apple_stubs}"/>
				<attribute name="Main-Class" value="com.trollworks.gcs.app.GCS"/>
				<attribute name="SplashScreen-Image" value="${splash_path}"/>
				<attribute name="bundle-name" value="${app_name}"/>
				<attribute name="bundle-version" value="${version}"/>
				<attribute name="bundle-license" value="Mozilla Public License 2.0"/>
				<attribute name="bundle-copyright-owner" value="${copyright_owner}"/>
				<attribute name="bundle-copyright-years" value="1998-${year}"/>
			</manifest>
		</jar>
	</target>

	<target name="icons" description="Packs the various iconsets into icns files">
		<delete dir="${icons}/app.icns"/>
		<exec executable="/usr/bin/iconutil" dir="${icons}">
			<arg value="--convert"/>
			<arg value="icns"/>
			<arg value="app.iconset"/>
		</exec>

		<delete dir="${icons}/gcs.icns"/>
		<exec executable="/usr/bin/iconutil" dir="${icons}">
			<arg value="--convert"/>
			<arg value="icns"/>
			<arg value="gcs.iconset"/>
		</exec>

		<delete dir="${icons}/gcs.icns"/>
		<exec executable="/usr/bin/iconutil" dir="${icons}">
			<arg value="--convert"/>
			<arg value="icns"/>
			<arg value="gct.iconset"/>
		</exec>

			<delete dir="${icons}/glb.icns"/>
			<exec executable="/usr/bin/iconutil" dir="${icons}">
				<arg value="--convert"/>
				<arg value="icns"/>
				<arg value="glb.iconset"/>
			</exec>
	</target>

	<target name="bundle" description="Bundle GCS up for distribution" depends="build">
		<taskdef name="bundleapp" classname="com.oracle.appbundler.AppBundlerTask" classpath="../toolkit/libraries/appbundler-1.0ea.jar"/>

		<!-- Bundle it up. -->
		<mkdir dir="${dist_root}"/>
		<bundleapp outputdirectory="${dist_root}"
					name="${app_name}"
					executablename="${app}"
					displayname="${app_name}"
					identifier="com.trollworks.gcs"
					mainclassname="com.trollworks.gcs.app.GCS"
					icon="${icons}/app.icns"
					shortversion="${primary_version}"
					version="${primary_version}"
					signature="RWGS"
					copyright="Copyright Â©1998-${year} by ${copyright_owner}. All rights reserved."
					applicationCategory="public.app-category.role-playing-games">
			<classpath file="${lib}/${app}-${primary_version}.jar" />
			<classpath file="${toolkit_path}"/>
			<classpath file="${trove_path}"/>
			<classpath file="${iText_path}"/>
			<classpath file="${apple_stubs_path}"/>
			<option value="-Xmx256m"/>
			<option value="-Xdock:name=${app_name}"/>
			<option value="-splash:$APP_ROOT/Contents/Resources/splash.gif"/>
			<runtime dir="${java.home}/.."/>
			<arch name="x86_64"/>
			<arch name="i386"/>
			<bundledocument extensions="gcs" icon="gcs.icns" name="GCS Character Sheet" role="editor"/>
			<bundledocument extensions="gct" icon="gct.icns" name="GCS Character Template" role="editor"/>
			<bundledocument extensions="glb" icon="glb.icns" name="GCS Library" role="editor"/>
		</bundleapp>

		<!-- Copy the icons for the documents, since the appbundler fails to do that. -->
		<copy file="${icons}/gcs.icns" todir="${bundle_res}"/>
		<copy file="${icons}/gct.icns" todir="${bundle_res}"/>
		<copy file="${icons}/glb.icns" todir="${bundle_res}"/>

		<!-- Copy the license. -->
		<copy file="license.html" todir="${dist_root}"/>

		<!-- Copy the splash image. -->
		<copy file="${gcs_build}/${splash_path}" tofile="${bundle_res}/splash.gif"/>

		<!-- Copy the samples. -->
		<mkdir dir="${dist_root}/samples"/>
		<copy todir="${dist_root}/samples">
			<fileset dir="samples"/>
		</copy>

		<!-- Copy the scripts, then adjust them to have the correct version and permissions. -->
		<copy todir="${dist_root}">
			<fileset dir="scripts"/>
		</copy>
		<replace dir="${dist_root}" includes="${app},${app}.bat">
			<replacefilter token="APP_VERSION" value="${primary_version}"/>
		</replace>
		<chmod perm="755" file="${dist_root}/${app}"/>

		<!-- Copy the database. -->
		<mkdir dir="${dist_root}/data"/>
		<copy todir="${dist_root}/data">
			<fileset dir="data"/>
		</copy>
		
		<!-- Create the zip file -->
		<zip destfile="${app}-${primary_version}.zip">
			<zipfileset dir="${dist_root}" filemode="755">
				<include name="${app}"/>
				<include name="${app_name}.app/Contents/MacOS/${app}"/>
			</zipfileset>
			<zipfileset dir="${dist_root}">
				<exclude name="${app}"/>
				<exclude name="${app_name}.app/Contents/MacOS/${app}"/>
			</zipfileset>
		</zip>
	</target>
</project>