<?xml version="1.0"?>
<project name="gcs" default="gcs">
	<property name="src" value="src"/>
	<property name="build_root" value="ant_build"/>
	<property name="package" value="com.trollworks.gcs"/>
	<property name="package_dir" value="com/trollworks/gcs"/>
	<property name="gcs_build" value="${build_root}/gcs"/>
	<property name="dist_build" value="${build_root}/dist"/>
	<property name="annotations_src" value="${build_root}/annotations"/>
	<property name="min_jdk" value="1.8"/>
	<property name="app_name" value="GURPS Character Sheet"/>
	<property name="copyright_owner" value="Richard A. Wilkes"/>
	<property name="primary_version" value="4.0.0"/>
	<tstamp>
		<format property="version" pattern="${primary_version}.yyyyMMddHHmmss"/>
	</tstamp>
	<tstamp>
		<format property="year" pattern="yyyy"/>
	</tstamp>

	<target name="clean" description="Clean up after a build">
		<delete dir="${build_root}"/>
		<delete>
			<fileset dir="." includes="GCS-*.zip"/>
		</delete>
	</target>

	<target name="gcs" description="Build GCS" depends="clean">
		<mkdir dir="${gcs_build}"/>
		<mkdir dir="${dist_build}"/>
		<mkdir dir="${annotations_src}"/>

		<!-- Compile the code. -->
		<javac srcdir="${src}" destdir="${gcs_build}" includes="${package_dir}/**"
			debug="no" optimize="yes" target="${min_jdk}" source="${min_jdk}" deprecation="true"
			includeantruntime="no">
			<classpath>
				<pathelement location="../com.trollworks.toolkit/libraries/com.trollworks.toolkit.jar"/>
				<pathelement location="../com.trollworks.toolkit/libraries/trove.jar"/>
				<pathelement location="libraries/iText.jar"/>
				<pathelement location="../apple_stubs/apple_stubs.jar"/>
			</classpath>
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-serial"/>
			<compilerarg value="-processorpath"/>
			<compilerarg value="../com.trollworks.toolkit/libraries/com.trollworks.toolkit.annotation.jar"/>
			<compilerarg value="-s"/>
			<compilerarg value="${annotations_src}"/>
			<compilerarg value="-implicit:class"/>
		</javac>
		
		<!-- Copy the resources over. -->
		<copy todir="${gcs_build}">
			<fileset dir="${src}" includes="**/*.properties,**/*.txt,**/*.png,**/*.gif"/>
		</copy>

		<!-- Load the remaining property values. -->
		<property name="DistDirName" value="GCS-${primary_version}"/>
		<property name="DistBuildDir" value="${dist_build}/${DistDirName}"/>
		<property name="AppBundle" value="${DistBuildDir}/${app_name}.app/Contents"/>
		<property name="AppDir" value="${AppBundle}/MacOS"/>
		<property name="ResourceDir" value="${AppBundle}/Resources"/>
		<property name="JavaDir" value="${AppBundle}/Java"/>
		<property name="ZipFile" value="${DistDirName}.zip"/>

		<!-- Copy the initial dist files over. -->
		<mkdir dir="${DistBuildDir}"/>
		<copy todir="${DistBuildDir}">
			<fileset dir="dist"/>
		</copy>
		<copy file="${gcs_build}/com/trollworks/gcs/app/images/Splash.gif" tofile="${ResourceDir}/splash.gif"/>
		<chmod perm="755" file="${AppDir}/JavaAppLauncher"/>
		<chmod perm="755" file="${DistBuildDir}/gcs"/>
		<mkdir dir="${DistBuildDir}/data"/>
		<copy todir="${DistBuildDir}/data">
			<fileset dir="data"/>
		</copy>
		<replace file="${AppBundle}/Info.plist">
			<replacefilter token="APP_NAME" value="${app_name}"/>
			<replacefilter token="APP_VERSION" value="${primary_version}"/>
			<replacefilter token="COPYRIGHT_YEARS" value="1998-${year}"/>
			<replacefilter token="COPYRIGHT_OWNER" value="${copyright_owner}"/>
		</replace>

		<!-- Create the jar file. -->
		<jar destfile="${JavaDir}/${package}.jar" basedir="${gcs_build}" duplicate="fail">
			<manifest>
				<attribute name="Class-Path" value="com.trollworks.toolkit.jar trove.jar iText.jar apple_stubs.jar"/>
				<attribute name="Main-Class" value="com.trollworks.gcs.app.GCS"/>
				<attribute name="SplashScreen-Image" value="com/trollworks/gcs/app/images/Splash.gif"/>
				<attribute name="bundle-name" value="${app_name}"/>
				<attribute name="bundle-version" value="${version}"/>
				<attribute name="bundle-license" value="Mozilla Public License 2.0"/>
				<attribute name="bundle-copyright-owner" value="${copyright_owner}"/>
				<attribute name="bundle-copyright-years" value="1998-${year}"/>
			</manifest>
		</jar>

		<!-- Copy the support jars over. -->
		<copy file="../com.trollworks.toolkit/libraries/com.trollworks.toolkit.jar" todir="${JavaDir}"/>
		<copy file="../com.trollworks.toolkit/libraries/trove.jar" todir="${JavaDir}"/>
		<copy file="libraries/iText.jar" todir="${JavaDir}"/>
		<copy file="../apple_stubs/apple_stubs.jar" todir="${JavaDir}"/>

		<!-- Create the zip file -->
		<zip destfile="${ZipFile}">
			<zipfileset dir="${dist_build}" filemode="755">
				<include name="${DistDirName}/gcs"/>
				<include name="${DistDirName}/${app_name}.app/Contents/MacOS/JavaAppLauncher"/>
			</zipfileset>
			<zipfileset dir="${dist_build}">
				<include name="${DistDirName}/**"/>
				<exclude name="${DistDirName}/gcs"/>
				<exclude name="${DistDirName}/${app_name}.app/Contents/MacOS/JavaAppLauncher"/>
			</zipfileset>
		</zip>
	</target>
</project>
