<?xml version="1.0"?>
<project name="gcs" default="dist">
	<property file="com/trollworks/gcs/app/GCS.properties"/>
	<property name="BuildDir" value="gcs_build"/>
	<property name="JavaBuildDir" value="${BuildDir}/java"/>
	<property name="DistDirName" value="GCS_${APP_VERSION}"/>
	<property name="DistBuildDir" value="${BuildDir}/${DistDirName}"/>
	<property name="AppBundle" value="${DistBuildDir}/${APP_NAME}.app/Contents"/>
	<property name="AppDir" value="${AppBundle}/MacOS"/>
	<property name="ResourceDir" value="${AppBundle}/Resources"/>
	<property name="JavaDir" value="${ResourceDir}/Java"/>
	<property name="ZipFile" value="${DistDirName}.zip"/>

	<target name="clean" description="Clean up after a build">
		<delete dir="${BuildDir}"/>
		<delete>
			<fileset dir="." includes="**/GCS_*.zip"/>
		</delete>
	</target>
	
	<target name="dist" description="Build GCS" depends="clean">
		<mkdir dir="${BuildDir}"/>
		<mkdir dir="${JavaBuildDir}"/>
		<mkdir dir="${DistBuildDir}"/>

		<!-- Copy the initial dist files over. -->
		<copy todir="${DistBuildDir}">
			<fileset dir="dist"/>
		</copy>
		<chmod perm="755" file="${AppDir}/JavaApplicationStub"/>
		<chmod perm="755" file="${DistBuildDir}/gcs"/>
		<mkdir dir="${DistBuildDir}/data"/>
		<copy todir="${DistBuildDir}/data">
			<fileset dir="data"/>
		</copy>
		<replace file="${AppBundle}/Info.plist">
			<replacefilter token="APP_NAME" value="${APP_NAME}"/>
			<replacefilter token="APP_VERSION" value="${APP_VERSION}"/>
			<replacefilter token="COPYRIGHT_YEARS" value="${APP_COPYRIGHT_YEARS}"/>
			<replacefilter token="COPYRIGHT_OWNER" value="${APP_COPYRIGHT_OWNER}"/>
		</replace>

		<!-- Compile the code. -->
		<unjar src="libraries/iText-2.1.2u.jar" dest="${JavaBuildDir}"/>
		<unjar src="libraries/iTextAsian.jar" dest="${JavaBuildDir}"/>
		<unjar src="../ttk/libraries/trove-2.1.0.jar" dest="${JavaBuildDir}"/>
		<javac destdir="${JavaBuildDir}" includes="com/trollworks/gcs/app/GCS.java" debug="no" optimize="yes" target="1.6" source="1.6">
			<src path="."/>
			<src path="../ttk"/>
		</javac>

		<!-- Remove invalid signing files from iText. -->
		<delete file="${JavaBuildDir}/META-INF/BRUNO_LO.RSA"/>
		<delete file="${JavaBuildDir}/META-INF/BRUNO_LO.SF"/>

		<!-- Copy the resources over. -->
		<copy todir="${JavaBuildDir}">
			<fileset dir="." includes="com/**/*.txt,com/**/*.properties,com/**/*.png,com/**/*.gif"/>
			<fileset dir="../ttk" includes="com/**/*.txt,com/**/*.properties,com/**/*.png,com/**/*.gif"/>
		</copy>

		<!-- Create the jar file and the Java 1.1 entry point. -->
		<javac srcdir="../ttk" destdir="${JavaBuildDir}" includes="com/trollworks/ttk/Launcher.java" debug="no" optimize="yes" target="1.1" source="1.1"/>
		<jar destfile="${JavaDir}/GCS.jar" basedir="${JavaBuildDir}" manifest="gcs.mf" duplicate="fail"/>

		<!-- Create the zip file -->
		<zip destfile="${ZipFile}">
			<zipfileset dir="${BuildDir}" filemode="755">
				<include name="${DistDirName}/gcs"/>
				<include name="${DistDirName}/${APP_NAME}.app/Contents/MacOS/JavaApplicationStub"/>
			</zipfileset>
			<zipfileset dir="${BuildDir}">
				<include name="${DistDirName}/**"/>
				<exclude name="${DistDirName}/gcs"/>
				<exclude name="${DistDirName}/${APP_NAME}.app/Contents/MacOS/JavaApplicationStub"/>
			</zipfileset>
		</zip>
	</target>
</project>
