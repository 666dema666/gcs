<?xml version="1.0"?>
<project name="gcs" default="gcs">
	<property name="app" value="gcs"/>
	<property name="src" value="src"/>
	<property name="lib" value="libraries"/>
	<property name="toolkit" value="toolkit-4.0.0.jar"/>
	<property name="toolkit_lib" value="../toolkit/libraries"/>
	<property name="toolkit_path" value="${toolkit_lib}/${toolkit}"/>
	<property name="apple_stubs" value="apple_stubs.jar"/>
	<property name="apple_stubs_path" value="../apple_stubs/${apple_stubs}"/>
	<property name="trove" value="trove-3.0.3.jar"/>
	<property name="trove_path" value="${toolkit_lib}/trove-3.0.3.jar"/>
	<property name="iText" value="iText-2.1.7.jar"/>
	<property name="iText_path" value="${lib}/${iText}"/>
	<property name="build_root" value="ant_build"/>
	<property name="gcs_build" value="${build_root}/${app}"/>
	<property name="dist_build" value="${build_root}/dist"/>
	<property name="annotations_src" value="${build_root}/annotations"/>
	<property name="min_jdk" value="1.8"/>
	<property name="app_name" value="GURPS Character Sheet"/>
	<property name="copyright_owner" value="Richard A. Wilkes"/>
	<property name="primary_version" value="4.0.0"/>
	<property name="dist_name" value="GCS-${primary_version}"/>
	<property name="dist_root" value="${dist_build}/${dist_name}"/>
	<property name="build_app_bundle" value="${dist_root}/${app_name}.app/Contents"/>
	<property name="java_bundle_dir" value="${build_app_bundle}/Java"/>
	<property name="app_launcher" value="${dist_name}/${app_name}.app/Contents/MacOS/JavaAppLauncher"/>
	<property name="splash_path" value="com/trollworks/gcs/app/images/Splash.gif"/>
	<tstamp>
		<format property="version" pattern="${primary_version}.yyyyMMddHHmmss"/>
	</tstamp>
	<tstamp>
		<format property="year" pattern="yyyy"/>
	</tstamp>

	<target name="clean" description="Clean up after a build">
		<delete dir="${build_root}"/>
		<delete>
			<fileset dir="." includes="GCS-*.zip"/>
		</delete>
	</target>

	<target name="gcs" description="Build GCS" depends="clean">
		<mkdir dir="${gcs_build}"/>
		<mkdir dir="${dist_build}"/>
		<mkdir dir="${annotations_src}"/>

		<!-- Compile the code. -->
		<javac srcdir="${src}" destdir="${gcs_build}" debug="no" optimize="yes"
			target="${min_jdk}" source="${min_jdk}" deprecation="true"
			includeantruntime="no">
			<classpath>
				<pathelement location="${toolkit_path}"/>
				<pathelement location="${trove_path}"/>
				<pathelement location="${iText_path}"/>
				<pathelement location="${apple_stubs_path}"/>
			</classpath>
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-serial"/>
			<compilerarg value="-processorpath"/>
			<compilerarg value="${toolkit_lib}/toolkit_annotation_processors.jar"/>
			<compilerarg value="-s"/>
			<compilerarg value="${annotations_src}"/>
			<compilerarg value="-implicit:class"/>
		</javac>
		
		<!-- Copy the resources over. -->
		<copy todir="${gcs_build}">
			<fileset dir="${src}" includes="**/*.properties,**/*.txt,**/*.png,**/*.gif"/>
		</copy>

		<!-- Copy the initial dist files over. -->
		<mkdir dir="${dist_root}"/>
		<copy todir="${dist_root}">
			<fileset dir="dist"/>
		</copy>
		<copy file="${gcs_build}/${splash_path}" tofile="${build_app_bundle}/Resources/splash.gif"/>
		<chmod perm="755" file="${build_app_bundle}/MacOS/JavaAppLauncher"/>
		<chmod perm="755" file="${dist_root}/${app}"/>
		<mkdir dir="${dist_root}/data"/>
		<copy todir="${dist_root}/data">
			<fileset dir="data"/>
		</copy>
		<replace file="${build_app_bundle}/Info.plist">
			<replacefilter token="APP_NAME" value="${app_name}"/>
			<replacefilter token="APP_VERSION" value="${primary_version}"/>
			<replacefilter token="COPYRIGHT_YEARS" value="1998-${year}"/>
			<replacefilter token="COPYRIGHT_OWNER" value="${copyright_owner}"/>
		</replace>
		<replace file="${dist_root}/gcs">
			<replacefilter token="APP_VERSION" value="${primary_version}"/>
		</replace>
		<replace file="${dist_root}/gcs.bat">
			<replacefilter token="APP_VERSION" value="${primary_version}"/>
		</replace>

		<!-- Create the jar file. -->
		<jar destfile="${java_bundle_dir}/${app}-${primary_version}.jar" basedir="${gcs_build}" duplicate="fail">
			<manifest>
				<attribute name="Class-Path" value="${toolkit} ${trove} ${iText} ${apple_stubs}"/>
				<attribute name="Main-Class" value="com.trollworks.gcs.app.GCS"/>
				<attribute name="SplashScreen-Image" value="${splash_path}"/>
				<attribute name="bundle-name" value="${app_name}"/>
				<attribute name="bundle-version" value="${version}"/>
				<attribute name="bundle-license" value="Mozilla Public License 2.0"/>
				<attribute name="bundle-copyright-owner" value="${copyright_owner}"/>
				<attribute name="bundle-copyright-years" value="1998-${year}"/>
			</manifest>
		</jar>

		<!-- Copy the support jars over. -->
		<copy file="${toolkit_path}" todir="${java_bundle_dir}"/>
		<copy file="${trove_path}" todir="${java_bundle_dir}"/>
		<copy file="${iText_path}" todir="${java_bundle_dir}"/>
		<copy file="${apple_stubs_path}" todir="${java_bundle_dir}"/>

		<!-- Create the zip file -->
		<zip destfile="${dist_name}.zip">
			<zipfileset dir="${dist_build}" filemode="755">
				<include name="${dist_name}/${app}"/>
				<include name="${app_launcher}"/>
			</zipfileset>
			<zipfileset dir="${dist_build}">
				<include name="${dist_name}/**"/>
				<exclude name="${dist_name}/${app}"/>
				<exclude name="${app_launcher}"/>
			</zipfileset>
		</zip>
	</target>
</project>