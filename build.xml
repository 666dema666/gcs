<?xml version="1.0"?>
<project name="gcs" default="dist">
	<property name="BuildDir" value="gcs_build"/>
	<property name="JavaBuildDir" value="${BuildDir}/java"/>

	<target name="clean" description="Clean up after a build">
		<delete dir="${BuildDir}"/>
		<delete>
			<fileset dir="." includes="GCS-*.zip"/>
		</delete>
	</target>

	<target name="dist" description="Build GCS" depends="clean">
		<mkdir dir="${BuildDir}"/>
		<mkdir dir="${JavaBuildDir}"/>

		<!-- Copy the resources over. -->
		<copy todir="${JavaBuildDir}">
			<fileset dir="." includes="com/**/*.txt,com/**/*.properties,com/**/*.png,com/**/*.gif"/>
		</copy>

		<!-- Update the version and copyright values. -->
		<tstamp>
			<format property="VERSION_YEAR" pattern="yyyy"/>
		</tstamp>
		<tstamp>
			<format property="VERSION" pattern="yyyy.MM.dd.HHmm"/>
		</tstamp>
		<replaceregexp file="${JavaBuildDir}/com/trollworks/gcs/app/GCS.properties"
					match='(APP_VERSION.+=)(.*)'
					replace='\1 ${VERSION}'/>
		<replaceregexp file="${JavaBuildDir}/com/trollworks/gcs/app/GCS.properties"
					match='(APP_COPYRIGHT_YEARS.+=)(.*)'
					replace='\1 1998-${VERSION_YEAR}'/>

		<!-- Load the remaining property values. -->
		<property file="${JavaBuildDir}/com/trollworks/gcs/app/GCS.properties"/>
		<property name="DistDirName" value="GCS-${APP_VERSION}"/>
		<property name="DistBuildDir" value="${BuildDir}/${DistDirName}"/>
		<property name="AppBundle" value="${DistBuildDir}/${APP_NAME}.app/Contents"/>
		<property name="AppDir" value="${AppBundle}/MacOS"/>
		<property name="ResourceDir" value="${AppBundle}/Resources"/>
		<property name="JavaDir" value="${AppBundle}/Java"/>
		<property name="ZipFile" value="${DistDirName}.zip"/>

		<!-- Copy the initial dist files over. -->
		<mkdir dir="${DistBuildDir}"/>
		<copy todir="${DistBuildDir}">
			<fileset dir="dist"/>
		</copy>
		<copy file="com/trollworks/gcs/app/images/Splash.gif" tofile="${ResourceDir}/splash.gif"/>
		<chmod perm="755" file="${AppDir}/JavaAppLauncher"/>
		<chmod perm="755" file="${DistBuildDir}/gcs"/>
		<mkdir dir="${DistBuildDir}/data"/>
		<copy todir="${DistBuildDir}/data">
			<fileset dir="data"/>
		</copy>
		<replace file="${AppBundle}/Info.plist">
			<replacefilter token="APP_NAME" value="${APP_NAME}"/>
			<replacefilter token="APP_VERSION" value="${APP_VERSION}"/>
			<replacefilter token="COPYRIGHT_YEARS" value="${APP_COPYRIGHT_YEARS}"/>
			<replacefilter token="COPYRIGHT_OWNER" value="${APP_COPYRIGHT_OWNER}"/>
		</replace>

		<!-- Compile the code. -->
		<javac destdir="${JavaBuildDir}"
					includes="com/trollworks/gcs/app/GCS.java"
					debug="no"
					optimize="yes"
					target="1.7"
					source="1.7"
					deprecation="true"
					includeantruntime="no">
			<classpath>
				<pathelement location="../ttk/TrollworksToolkit.jar"/>
				<pathelement location="../ttk/libraries/Trove.jar"/>
				<pathelement location="libraries/iText.jar"/>
			</classpath>
			<src path="."/>
			<!-- <compilerarg value="-Xlint:unchecked"/> -->
		</javac>

		<!-- Create the GCS jar file and copy over the various library jar files. -->
		<jar destfile="${JavaDir}/GCS.jar" basedir="${JavaBuildDir}" manifest="gcs.mf" duplicate="fail"/>
		<copy file="../ttk/TrollworksToolkit.jar" todir="${JavaDir}"/>
		<copy file="../ttk/libraries/Trove.jar" todir="${JavaDir}"/>
		<copy file="libraries/iText.jar" todir="${JavaDir}"/>

		<!-- Create the zip file -->
		<zip destfile="${ZipFile}">
			<zipfileset dir="${BuildDir}" filemode="755">
				<include name="${DistDirName}/gcs"/>
				<include name="${DistDirName}/${APP_NAME}.app/Contents/MacOS/JavaAppLauncher"/>
			</zipfileset>
			<zipfileset dir="${BuildDir}">
				<include name="${DistDirName}/**"/>
				<exclude name="${DistDirName}/gcs"/>
				<exclude name="${DistDirName}/${APP_NAME}.app/Contents/MacOS/JavaAppLauncher"/>
			</zipfileset>
		</zip>
	</target>
</project>
